# SQL Schema 개발 및 관리 메뉴얼

> 최초작성일: 2025-11-06  
> 최신개정일: 2025-11-06  
> 최신개정자: 이한경  
> 작성자: 이한경  

- 이 프로젝트는 sqlite3를 사용합니다.

## DB 파일

- DB 파일은 `/db` 폴더에 위치해야 합니다.
- 파일의 경로는 `.env` 파일로 설정합니다. 

## SQL 스크립트

- SQL 스크립트 파일 및 이에 필요한 데이터 파일은 `/script/migrations/` 폴더에 있습니다.
- 이 문서 최초 작성 시 DB 초기화 스크립트를 기준으로 `B7__baseline.sql`을 작성하였습니다. 
  - 기존에 생성된 DB에 2~7.sql 파일을 순서대로 실행한 결과와 B7을 단독으로 실행한 결과가 동일합니다. 7.sql 까지 실행한 기존 DB와 B7으로 생성된 DB 파일 모두 V8과 그 이후 마이그레이션을 동일하게 사용합니다. 
  - B7을 실행하기 위해 csv 파일 2개가 필요합니다.
    - `majors.csv`: 단과대명과 전공명으로 이루어진 파일로 `major` 테이블에 추가됩니다.
    - `check_user_status_rules.csv`: user status에 따라 금지되는 API 경로를 `check_user_status_rule` 테이블에 추가합니다. `CheckUserStatusMiddleware`에 의해 사용됩니다.
- 새로 생성되는 DB 파일은 B7과 그 이후 마이그레이션을 순서대로 실행하여 생성됩니다.
  - `B7 -> V8 -> V9 -> V10 ...`
- 기존에 생성된 DB 파일은 7.sql 파일까지 순서대로 실행한 뒤 이후 마이그레이션을 순서대로 실행하여 최신화합니다. 
  - `2.sql -> ... -> 7.sql -> V8 -> V9 -> ...`

### DB 마이그레이션 작성법

- 마이그레이션 파일은 `V{i}__description.sql` 형식의 이름으로 `/script/migrations/` 폴더에 작성합니다. B7 이후 마이그레이션은 V8, V9, V10 등으로 작성합니다. 
- 한 번 작성된 마이그레이션을 수정하여서는 안 됩니다. 마이그레이션은 버전 숫자가 더 작은 모든 파일이 반영되었음을 가정합니다. 
- 마이그레이션은 유효한 SQLite3 문법을 사용해야 하고, 되도록 마이그레이션 전체를 하나의 트랜잭션으로 작성합니다.
- DB 초기 생성을 편리하게 하기 위해 `/script/migrations/index.sh` 파일을 작성합니다. 마이그레이션을 추가할 때 `index.sh`에 기존 마이그레이션에 이어서 새로운 마이그레이션이 실행될 수 있도록 스크립트를 추가합니다. B7 파일의 실행 스크립트가 `index.sh`에 포함되어 있으니, 자세한 사항은 `index.sh`을 참고하시기 바랍니다. 


### 기존 파일 관련 사항 및 예시 데이터 추가 스크립트 

- `{i}.sql` 파일명을 가진 마이그레이션과 DB 생성 스크립트를 동시에 관리하던 방식을 이 문서 최초 작성과 함께 개선하여 이전에 작성된 2~7.sql 파일이 존재합니다. 종전에 생성된 DB 파일의 마이그래이션을 위해 이를 보존 중입니다. 

- `docker-compose.yml` 파일에 따라 `index.sh` 실행 직후 실행되는 `insert_sample_data/insert_president_users.sh` 스크립트가 존재합니다. 
  - 이를 실행하기 위해 `presidents.csv` 파일이 필요합니다. 이 파일이 존재하지 않으면 이 스크립트는 실행을 건너뜁니다. 
  - `presidents.csv`: 이메일과 이름으로 이루어진 파일로 `user` 테이블에 추가됩니다. `presidents.example.csv` 파일의 값은 예시 값입니다. 마이그래이션 파일에 의해 해당 값은 이미 DB에 추가되어 있으며, `presidents.csv`에 예시 값을 포함하면 해당 값은 무시됩니다. `/script/init_db/` 경로에 파일이 있었다면 `/script/insert_sample_data/` 경로로 옮겨야 합니다. 

- `script/insert_sample_data/` 경로에는 `insert_president_users.sh` 외의 여러 예시 데이터 추가 스크립트가 존재합니다. 
  - 이 스크립트들은 `index.sh` 파일을 통해 한 번에 모두 실행할 수 있습니다. 
